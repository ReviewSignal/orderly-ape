environments:
  default:
    values:
      - orderlyApe:
          chartVersion: 0.0.1-dev.63
      - certManager:
          chartVersion: v1.16.2
      - ingressNginx:
          chartVersion: 4.11.3
      - grafana:
          chartVersion: 8.6.4
      - influxdb:
          chartVersion: 2.1.2
          image:
            tag: 2.7.10-alpine
      - values.yaml
---
repositories:
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx
  - name: jetstack
    url: https://charts.jetstack.io
  - name: influxdata
    url: https://helm.influxdata.com/
  - name: grafana
    url: https://grafana.github.io/helm-charts

releases:
  - name: cert-manager
    namespace: orderly-ape
    chart: jetstack/cert-manager
    version: "{{ .Values.certManager.chartVersion }}"
    wait: true
    values:
      - crds:
          enabled: true
        global:
          leaderElection:
            namespace: orderly-ape

  - name: orderly-ape-issuer
    namespace: orderly-ape
    chart: ./k8s-resource
    needs:
      - cert-manager
    values:
      - resources:
         - apiVersion: cert-manager.io/v1
           kind: Issuer
           metadata:
             name: orderly-ape
           spec:
             acme:
               server: https://acme-v02.api.letsencrypt.org/directory
               privateKeySecretRef:
                 name: orderly-ape-issuer-account-key
               solvers:
                 - http01:
                     ingress:
                      ingressClassName: orderly-ape

  - name: ingress-nginx
    namespace: orderly-ape
    chart: ingress-nginx/ingress-nginx
    version: "{{ .Values.ingressNginx.chartVersion }}"
    wait: true
    needs:
      - cert-manager
    values:
      - controller:
          ingressClass: "orderly-ape"
          ingressClassResource:
            name: "orderly-ape"
          watchNamespace: "orderly-ape"

  - name: influxdb
    namespace: orderly-ape
    chart: influxdata/influxdb2
    version: "{{ .Values.influxdb.chartVersion }}"
    needs:
      - ingress-nginx
      - cert-manager
      - orderly-ape-issuer
    values:
      - image:
          tag: {{ .Values.influxdb.image.tag | quote }}
      - nameOverride: influxdb
      - adminUser:
          organization: default
          password: {{ .Values.influxdb.adminPassword | quote }}
      - persistence:
          enabled: true
          size: {{ .Values | get "influxdb.diskSize" "50Gi" | quote }}
      - ingress:
          enabled: true
          className: orderly-ape
          annotations:
            cert-manager.io/issuer: orderly-ape
          hostname: {{ .Values.influxdb.host }}
          tls: true
          secretName: influxdb-tls
      - pdb:
          create: false
      - resources:
          requests:
            memory: 2G
            cpu: 1
          limits:
            memory: 2G

  - name: grafana
    namespace: orderly-ape
    chart: grafana/grafana
    version: "{{ .Values.grafana.chartVersion }}"
    needs:
      - ingress-nginx
      - cert-manager
      - orderly-ape-issuer
    values:
      - adminPassword: {{ .Values.grafana.adminPassword | quote }}
      - ingress:
          enabled: true
          ingressClassName: orderly-ape
          annotations:
            cert-manager.io/issuer: orderly-ape
          hosts:
            - {{ .Values.grafana.host }}
          tls:
            - secretName: grafana-tls
              hosts:
                - {{ .Values.grafana.host }}
      - deploymentStrategy:
          type: Recreate
      - persistence:
          enabled: true
          size: {{ .Values | get "grafana.diskSize" "10Gi" | quote }}
      - extraSecretMounts:
        - name: influxdb
          mountPath: /run/secrets/influxdb
          secretName: influxdb-auth
          readOnly: true
      - datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: InfluxDB
                type: influxdb
                access: proxy
                url: http://influxdb
                jsonData:
                  user: admin
                  version: Flux
                  organization: default
                  defaultBucket: default
                secureJsonData:
                  token: $__file{/run/secrets/influxdb/admin-token}
      - dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
              - name: "default"
                orgId: 1
                folder: ""
                type: file
                disableDeletion: false
                editable: true
                options:
                  path: /var/lib/grafana/dashboards/default
      - dashboards:
          default:
            test-results:
              url: https://raw.githubusercontent.com/ReviewSignal/orderly-ape/main/grafana/test-results.json
              datasource:
                - name: DS_INFLUXDB
                  value: InfluxDB

  - name: orderly-ape-database
    namespace: orderly-ape
    chart: ./k8s-resource
    values:
      - resources:
          - apiVersion: databases.digitalocean.com/v1alpha1
            kind: DatabaseClusterReference
            metadata:
              name: orderly-ape-db
              namespace: orderly-ape
            spec:
              uuid: {{ .Values.digitalocean.mysql.uuid | quote }}
          - apiVersion: databases.digitalocean.com/v1alpha1
            kind: DatabaseUser
            metadata:
              name: orderly-ape-db
              namespace: orderly-ape
            spec:
              databaseCluster:
                apiGroup: databases.digitalocean.com
                kind: DatabaseClusterReference
                name: orderly-ape-db
              username: orderly-ape
          - apiVersion: batch/v1
            kind: Job
            metadata:
              name: orderly-ape-init-db
              namespace: orderly-ape
              annotations:
                "helm.sh/hook": post-install,post-upgrade
            spec:
              template:
                spec:
                  restartPolicy: Never
                  containers:
                  - name: mysql-client
                    image: alpine/mysql
                    command:
                      - "sh"
                      - "-c"
                      - mysql -h $DB_HOST -P $DB_PORT -u $DB_USERNAME -p$DB_PASSWORD -e 'CREATE DATABASE IF NOT EXISTS `orderly-ape`;'
                    env:
                    - name: DB_HOST
                      valueFrom:
                        configMapKeyRef:
                          name: orderly-ape-db-private-connection
                          key: host
                    - name: DB_PORT
                      valueFrom:
                        configMapKeyRef:
                          name: orderly-ape-db-private-connection
                          key: port
                    - name: DB_USERNAME
                      valueFrom:
                        secretKeyRef:
                          name: orderly-ape-db-credentials
                          key: username
                    - name: DB_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: orderly-ape-db-credentials
                          key: password

  - name: orderly-ape-k6-local-bootstrap
    namespace: orderly-ape
    chart: ./k8s-resource
    values:
      - resources:
          - apiVersion: v1
            kind: Secret
            metadata:
              name: orderly-ape-k6-local-bootstrap
              namespace: orderly-ape
              annotations:
                "helm.sh/hook": pre-install
            data:
              password: {{ .Values.orderlyape.workerBootstrapPassword | b64enc | quote }}

  - name: orderly-ape
    namespace: orderly-ape
    # chart: ../charts/webapp
    chart: oci://ghcr.io/reviewsignal/orderly-ape/charts/orderly-ape
    version: "{{ .Values.orderlyApe.chartVersion }}"
    needs:
      - ingress-nginx
      - cert-manager
      - orderly-ape-issuer
      - influxdb
      - grafana
      - orderly-ape-database
      - orderly-ape-k6-local-bootstrap
    values:
    - adminPassword: {{ .Values.orderlyape.adminPassword | quote }}
    - image:
        tag: "{{ .Values.orderlyape.version }}"
    - resources:
        limits:
          cpu: "0.5"
          memory: "1G"
        requests:
          cpu: "0.5"
          memory: "1G"
    - ingress:
        enabled: true
        className: orderly-ape
        annotations:
          cert-manager.io/issuer: orderly-ape
        hosts:
        - host: {{ .Values.orderlyape.host }}
          paths:
          - path: /
            pathType: Prefix
        tls:
        - secretName: orderly-ape-tls
          hosts:
            - {{ .Values.orderlyape.host }}
    - env:
      - name: DATABASE_HOST
        valueFrom:
          configMapKeyRef:
            name: orderly-ape-db-private-connection
            key: host
      - name: DATABASE_PORT
        valueFrom:
          configMapKeyRef:
            name: orderly-ape-db-private-connection
            key: port
      - name: DATABASE_USER
        valueFrom:
          secretKeyRef:
            name: orderly-ape-db-credentials
            key: username
      - name: DATABASE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: orderly-ape-db-credentials
            key: password
      - name: DATABASE_URL
        value: mysql://$(DATABASE_USER):$(DATABASE_PASSWORD)@$(DATABASE_HOST):$(DATABASE_PORT)/orderly-ape
      - name: GRAFANA_DASHBOARD_URL
        value: https://{{ .Values.grafana.host }}/d/bdqz4a3k8j08wa?orgId=1
      - name: INFLUXDB_URL
        value: https://{{ .Values.influxdb.host }}
      - name: INFLUXDB_ORG
        value: default
      - name: INFLUXDB_BUCKET
        value: default
      - name: INFLUXDB_TOKEN
        valueFrom:
          secretKeyRef:
            name: influxdb-auth
            key: admin-token
      - name: INITIAL_WORKER_PASSWORD
        valueFrom:
          secretKeyRef:
            name: orderly-ape-k6-local-bootstrap
            key: password

  - name: k6-operator
    namespace: k6-local
    # chart: ../charts/k6-operator
    chart: oci://ghcr.io/reviewsignal/orderly-ape/charts/k6-operator
    version: "{{ .Values.orderlyApe.chartVersion }}"
    needs:
      - orderly-ape/orderly-ape-k6-local-bootstrap
      - orderly-ape/orderly-ape
    values:
      - image:
          tag: "{{ .Values.orderlyape.version }}"
      - config:
          region: local
          api:
            endpoint: https://{{ .Values.orderlyape.host }}/api
            user: worker-local
            password: {{ .Values.orderlyape.workerBootstrapPassword | quote }}
      - resources:
          limits:
            cpu: "0.5"
            memory: "1G"
          requests:
            cpu: "0.5"
            memory: "1G"
